# Common Agent æ¶æ„ä¸æ•°æ®æµè¯¦è§£

## ğŸ“ ç³»ç»Ÿæ¶æ„å›¾

### 1. é«˜å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯ (UI)                              â”‚
â”‚                    ç”¨æˆ·è¾“å…¥é—®é¢˜ä¸èµ„æºé€‰æ‹©                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API å±‚ (LangServe)                          â”‚
â”‚              æ¥æ”¶è¯·æ±‚ â†’ åˆ›å»ºState â†’ è°ƒç”¨Chain                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Common Agent Chain                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  1. åˆå§‹åŒ– (Initialization)                           â”‚    â”‚
â”‚  â”‚     - åˆ›å»ºCommonAgentState                            â”‚    â”‚
â”‚  â”‚     - åˆå§‹åŒ–å·¥å…·è°ƒç”¨æ˜ å°„                              â”‚    â”‚
â”‚  â”‚     - è·å–ç”¨æˆ·èƒŒæ™¯ä¿¡æ¯                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  2. æ¶ˆæ¯æ„å»º (Message Building)                       â”‚    â”‚
â”‚  â”‚     - SystemMessage: Prompt + ç”¨æˆ·èƒŒæ™¯                â”‚    â”‚
â”‚  â”‚     - HumanMessage: å½“å‰é—®é¢˜                          â”‚    â”‚
â”‚  â”‚     - Tool Messages: å†å²å·¥å…·è°ƒç”¨                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  3. LLM æ¨ç† (LLM Reasoning)                          â”‚    â”‚
â”‚  â”‚     - è°ƒç”¨LLMè¿›è¡Œæ„å›¾è¯†åˆ«                             â”‚    â”‚
â”‚  â”‚     - å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·                                â”‚    â”‚
â”‚  â”‚     - ç”Ÿæˆå·¥å…·è°ƒç”¨å‚æ•°                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  4. å·¥å…·è·¯ç”± (Tool Routing)                           â”‚    â”‚
â”‚  â”‚     - æ ¹æ®LLMå†³ç­–é€‰æ‹©å·¥å…·                             â”‚    â”‚
â”‚  â”‚     - æ„å»ºå·¥å…·è°ƒç”¨æ¶ˆæ¯                                â”‚    â”‚
â”‚  â”‚     - åˆ†å‘åˆ°å¯¹åº”çš„Sub-Agent                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  5. ç»“æœæ”¶é›† (Result Collection)                      â”‚    â”‚
â”‚  â”‚     - æ‰§è¡ŒSub-Agent                                   â”‚    â”‚
â”‚  â”‚     - æ•è·å·¥å…·è¾“å‡º                                    â”‚    â”‚
â”‚  â”‚     - æ›´æ–°çŠ¶æ€                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  6. å†³ç­–ç»§ç»­ (Continue Decision)                      â”‚    â”‚
â”‚  â”‚     - æ˜¯å¦éœ€è¦ç»§ç»­æ‰§è¡Œ?                               â”‚    â”‚
â”‚  â”‚     - æ˜¯ â†’ å›åˆ°ç¬¬3æ­¥                                  â”‚    â”‚
â”‚  â”‚     - å¦ â†’ è¿›å…¥ç¬¬7æ­¥                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  7. è¿”å›å“åº” (Return Response)                        â”‚    â”‚
â”‚  â”‚     - æ„å»ºCommonAgentResponse                         â”‚    â”‚
â”‚  â”‚     - åŒ…å«ç»“æœå’ŒçŠ¶æ€ä¿¡æ¯                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Sub-Agents (å­ä»£ç†)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Data      â”‚  â”‚   Text2SQL   â”‚  â”‚   Fix SQL    â”‚           â”‚
â”‚  â”‚ Discovery   â”‚  â”‚   Agent      â”‚  â”‚   Agent      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Chat BI   â”‚  â”‚ Explain SQL  â”‚  â”‚   Logify     â”‚           â”‚
â”‚  â”‚   Agent     â”‚  â”‚   Agent      â”‚  â”‚   Agent      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯æœåŠ¡                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Hive/    â”‚  â”‚  Milvus    â”‚  â”‚  Elasticsearch
  â”‚               â”‚
â”‚  â”‚  Presto    â”‚  â”‚            â”‚  â”‚            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å·¥å…·è·¯ç”±æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LLM å†³ç­– (Tool Selection)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ åˆ†æç”¨æˆ·æ„å›¾ â†’ é€‰æ‹©å·¥å…· â†’ ç”Ÿæˆè°ƒç”¨å‚æ•°                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Tool    â”‚   â”‚ Tool     â”‚   â”‚ Tool     â”‚
   â”‚ Dispatchâ”‚   â”‚ Registry â”‚   â”‚ Execution
  â”‚
   â”‚ (è·¯ç”±)  â”‚   â”‚ (æ³¨å†Œè¡¨) â”‚   â”‚ (æ‰§è¡Œ)   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ToolNode (LangGraph)      â”‚
        â”‚  - æ‰§è¡Œå¯¹åº”çš„å·¥å…·å‡½æ•°      â”‚
        â”‚  - æ•è·è¾“å‡ºæˆ–é”™è¯¯          â”‚
        â”‚  - è¿”å›ToolMessage         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Sub-Agent Chain           â”‚
        â”‚  - Data Discovery          â”‚
        â”‚  - Text2SQL               â”‚
        â”‚  - Fix SQL                â”‚
        â”‚  - Chat BI                â”‚
        â”‚  - ç­‰ç­‰...                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### 1. è¾“å…¥æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚
â”‚
â”œâ”€ question (str)
â”‚  â””â”€ ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€é—®é¢˜
â”‚
â”œâ”€ chat_context (dict)
â”‚  â”œâ”€ user_email (str)
â”‚  â”œâ”€ region (str)
â”‚  â”œâ”€ department (str)
â”‚  â””â”€ å…¶ä»–ç”¨æˆ·ä¿¡æ¯
â”‚
â”œâ”€ chat_history (list)
â”‚  â”œâ”€ {"human": "å‰ä¸€ä¸ªé—®é¢˜", "ai": "å‰ä¸€ä¸ªå›ç­”"}
â”‚  â”œâ”€ {"human": "...", "ai": "..."}
â”‚  â””â”€ ...
â”‚
â”œâ”€ selected_assets (list)
â”‚  â”œâ”€ {"type": "DataMart", "name": "Order Mart"}
â”‚  â”œâ”€ {"type": "HiveTable", "name": "SG.mp_user.order_tb"}
â”‚  â””â”€ ...
â”‚
â””â”€ table_context (dict)
   â””â”€ {"hive_tables": [...]}

            â†“

    Common Agent State åˆå§‹åŒ–
```

### 2. çŠ¶æ€è½¬æ¢æµ

```
åˆå§‹åŒ–çŠ¶æ€
â”‚
â”œâ”€ messages: [SystemMessage]
â”œâ”€ session_tool_call_info: {}
â”œâ”€ chat_tool_call_info: {}
â””â”€ selected_tables: []

            â†“

LLMæ¨ç†å¹¶ç”Ÿæˆå·¥å…·è°ƒç”¨

            â†“

å·¥å…·æ‰§è¡ŒçŠ¶æ€
â”‚
â”œâ”€ messages: [SystemMessage, HumanMessage, AIMessage]
â”œâ”€ session_tool_call_info: {
â”‚  â”œâ”€ "tool_call_id_123": {
â”‚  â”‚  â”œâ”€ name: "find_data"
â”‚  â”‚  â”œâ”€ input: {...}
â”‚  â”‚  â””â”€ output: {...}
â”‚  â””â”€ }
â”œâ”€ chat_tool_call_info: {...}
â””â”€ ask_human: null (å¦‚æœéœ€è¦ç”¨æˆ·ç¡®è®¤)

            â†“

ç»“æœæ”¶é›†çŠ¶æ€
â”‚
â”œâ”€ æ‰€æœ‰å·¥å…·è°ƒç”¨å·²å®Œæˆ
â”œâ”€ æœ€ç»ˆçŠ¶æ€å·²æ„å»º
â””â”€ é”™è¯¯ä¿¡æ¯å·²æ”¶é›† (å¦‚æœ‰)

            â†“

è¿”å›å“åº”
```

### 3. å·¥å…·è°ƒç”¨é“¾æµç¨‹

```
å·¥å…·è°ƒç”¨1 (find_data)
â”‚
â”œâ”€ Input: {table_name: "order", ...}
â”œâ”€ Process: æŸ¥è¯¢è¡¨ç»“æ„
â””â”€ Output: {table_details: {...}, columns: [...]}

            â†“

å·¥å…·è°ƒç”¨2 (generate_sql)
â”‚
â”œâ”€ Input: {table_details: ä¸Šä¸€ä¸ªOutput, question: ...}
â”œâ”€ Process: ç”ŸæˆSQL
â””â”€ Output: {sql: "SELECT ...", ...}

            â†“

å·¥å…·è°ƒç”¨3 (execute_sql_and_analyze_result)
â”‚
â”œâ”€ Input: {sql: ä¸Šä¸€ä¸ªOutput, ...}
â”œâ”€ Process: æ‰§è¡ŒSQLå¹¶åˆ†æ
â””â”€ Output: {result: [...], analysis: "..."}

            â†“

è¿”å›æœ€ç»ˆç»“æœ
```

---

## ğŸ“Š çŠ¶æ€æ•°æ®ç»“æ„

### CommonAgentState å®Œæ•´ç»“æ„

```
CommonAgentState {
    â”Œâ”€ åŸºæœ¬ä¿¡æ¯
    â”œâ”€ run_name: str
    â”œâ”€ question: str
    â”œâ”€ chat_id: int
    â”œâ”€ session_id: int
    â”œâ”€ agent_name: str
    â”‚
    â”Œâ”€ æ‰§è¡Œæ§åˆ¶
    â”œâ”€ max_execute_second: float
    â”œâ”€ start_unix_timestamp: float
    â”œâ”€ timeout_timestamp: float
    â”‚
    â”Œâ”€ ç”¨æˆ·äº¤äº’
    â”œâ”€ chat_context: dict {
    â”‚  â”œâ”€ user_email: str
    â”‚  â”œâ”€ user_background_info: str
    â”‚  â”œâ”€ region: str
    â”‚  â”œâ”€ department: str
    â”‚  â””â”€ ...
    â”‚
    â”œâ”€ ask_human: str (å¯é€‰)
    â”œâ”€ ask_human_sub_tool_name: str (å¯é€‰)
    â”œâ”€ ask_human_sub_tool_call_id: str (å¯é€‰)
    â”‚
    â”Œâ”€ èµ„æºé€‰æ‹©
    â”œâ”€ selected_tables: List[str]
    â”œâ”€ selected_assets: List[dict]
    â”œâ”€ chat_dataset_sample_data_mapping: dict
    â”œâ”€ chat_dataset_description_mapping: dict
    â”‚
    â”Œâ”€ å·¥å…·è°ƒç”¨è¿½è¸ª
    â”œâ”€ session_tool_call_info: ToolCallInfo {
    â”‚  â”œâ”€ tool_call_output_mapping: dict
    â”‚  â”œâ”€ tool_call_name_mapping: dict
    â”‚  â””â”€ tool_call_input_mapping: dict
    â”‚
    â”œâ”€ chat_tool_call_info: ToolCallInfo {
    â”‚  â”œâ”€ tool_call_output_mapping: dict
    â”‚  â”œâ”€ tool_call_name_mapping: dict
    â”‚  â””â”€ tool_call_input_mapping: dict
    â”‚
    â”Œâ”€ æ¶ˆæ¯å†å²
    â”œâ”€ messages: List[BaseMessage] {
    â”‚  â”œâ”€ SystemMessage (Prompt + ç”¨æˆ·èƒŒæ™¯)
    â”‚  â”œâ”€ HumanMessage (ç”¨æˆ·é—®é¢˜)
    â”‚  â”œâ”€ AIMessage (LLMå†³ç­–)
    â”‚  â”œâ”€ ToolMessage (å·¥å…·ç»“æœ)
    â”‚  â””â”€ ...
    â”‚
    â”Œâ”€ SQLå¤„ç†
    â”œâ”€ original_sql: str (å¯é€‰)
    â”œâ”€ sql_dialect: str
    â”‚
    â”Œâ”€ é”™è¯¯å¤„ç†
    â”œâ”€ has_internal_error: bool
    â”œâ”€ internal_error_message: str
    â”œâ”€ error_message: str
    â”‚
    â”Œâ”€ å…¶ä»–
    â”œâ”€ log_store_id: int (å¯é€‰)
    â”œâ”€ thread_id: str (å¯é€‰)
    â”œâ”€ support_skip_auth: bool
    â”œâ”€ interruption_reason: str
    â”œâ”€ has_variable: bool
    â””â”€ is_followup: bool
}
```

---

## ğŸ”€ æ¶ˆæ¯æµè½¬è¯¦è§£

### å®Œæ•´çš„æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ

```
Step 1: ç”¨æˆ·æäº¤é—®é¢˜
Input: {
    question: "åˆ†æè®¢å•æ•°æ®",
    chat_history: [{human: "...", ai: "..."}],
    chat_context: {...},
    selected_assets: [...]
}

            â†“

Step 2: åˆå§‹åŒ–çŠ¶æ€
state.messages = [
    SystemMessage(Prompt + ç”¨æˆ·èƒŒæ™¯)
]
state.question = "åˆ†æè®¢å•æ•°æ®"
state.selected_assets = [...]

            â†“

Step 3: è½¬æ¢èŠå¤©å†å²
state.messages.append(HumanMessage("å‰ä¸€ä¸ªé—®é¢˜"))
state.messages.append(AIMessage("å‰ä¸€ä¸ªå›ç­”"))
state.messages.append(HumanMessage("åˆ†æè®¢å•æ•°æ®"))

            â†“

Step 4: LLM ç”Ÿæˆå·¥å…·è°ƒç”¨
LLMè¿”å›:
{
    tool_calls: [{
        id: "call_123",
        function: {
            name: "find_data",
            arguments: {...}
        }
    }]
}

            â†“

Step 5: æ„å»ºå·¥å…·è°ƒç”¨æ¶ˆæ¯
state.messages.append(AIMessage(tool_calls=[...]))

            â†“

Step 6: æ‰§è¡Œå·¥å…·
ToolNodeæ‰§è¡Œfind_data â†’ è¿”å›ç»“æœ

            â†“

Step 7: æ„å»ºå·¥å…·ç»“æœæ¶ˆæ¯
state.messages.append(ToolMessage(
    tool_call_id="call_123",
    name="find_data",
    content="{...result...}"
))

            â†“

Step 8: æ›´æ–°å·¥å…·è°ƒç”¨æ˜ å°„
state.session_tool_call_info.tool_call_id_mapping["call_123"] = {...}

            â†“

Step 9: å†³ç­–æ˜¯å¦ç»§ç»­
IF éœ€è¦æ›´å¤šå·¥å…·è°ƒç”¨:
    LOOP å›åˆ° Step 4
ELSE:
    è¿›å…¥ Step 10

            â†“

Step 10: æ„å»ºæœ€ç»ˆå“åº”
return CommonAgentResponse(
    response_agent: "Chat BI Agent",
    sub_agent_response: {...},
    mid_state: state.session_tool_call_info
)
```

---

## ğŸ¯ å†³ç­–èŠ‚ç‚¹è¯¦è§£

### èŠ‚ç‚¹1: å·¥å…·é€‰æ‹©å†³ç­–

```
LLMåˆ†æç”¨æˆ·é—®é¢˜
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤?
â”‚  â”œâ”€ YES â†’ ask_human
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦æ¾„æ¸…æ•°æ®åŸŸ?
â”‚  â”œâ”€ YES â†’ detect_data_domain
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦æŸ¥è¯¢è¡¨?
â”‚  â”œâ”€ YES â†’ find_data
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦ç”ŸæˆSQL?
â”‚  â”œâ”€ YES â†’ generate_sql
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦ä¿®å¤SQL?
â”‚  â”œâ”€ YES â†’ fix_sql
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦æ‰§è¡ŒSQL?
â”‚  â”œâ”€ YES â†’ execute_sql_and_analyze_result
â”‚  â””â”€ NO â†“
â”‚
â””â”€ è¿”å›é”™è¯¯æˆ–ç›´æ¥å›å¤
```

### èŠ‚ç‚¹2: ç»§ç»­æ‰§è¡Œå†³ç­–

```
å·¥å…·æ‰§è¡Œå®Œæˆ
â”‚
â”œâ”€ æœ€ç»ˆæ„å›¾å·²è¾¾æˆ?
â”‚  â”œâ”€ YES â†’ è¿”å›ç»“æœ (Step 10)
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ éœ€è¦è°ƒç”¨å…¶ä»–å·¥å…·?
â”‚  â”œâ”€ YES â†’ ç»§ç»­å¾ªç¯ (Step 4)
â”‚  â””â”€ NO â†“
â”‚
â””â”€ è¿”å›ä¸­é—´ç»“æœ
```

---

## ğŸ” é”™è¯¯å¤„ç†æµç¨‹

```
æ‰§è¡Œå·¥å…·
â”‚
â”œâ”€ æˆåŠŸ?
â”‚  â”œâ”€ YES â†’ è¿”å›ç»“æœ
â”‚  â””â”€ NO â†“
â”‚
â”œâ”€ é”™è¯¯ç±»å‹?
â”‚  â”œâ”€ æƒé™é”™è¯¯
â”‚  â”‚  â””â”€ è¿”å›æƒé™é”™è¯¯æ¶ˆæ¯
â”‚  â”‚
â”‚  â”œâ”€ SQLè¯­æ³•é”™è¯¯
â”‚  â”‚  â”œâ”€ å¦‚æœéœ€è¦ â†’ è°ƒç”¨fix_sql
â”‚  â”‚  â””â”€ è¿”å›é”™è¯¯
â”‚  â”‚
â”‚  â”œâ”€ ç½‘ç»œé”™è¯¯
â”‚  â”‚  â”œâ”€ é‡è¯• (æŒ‡æ•°é€€é¿)
â”‚  â”‚  â””â”€ æœ€ç»ˆå¤±è´¥è¿”å›
â”‚  â”‚
â”‚  â””â”€ å…¶ä»–é”™è¯¯
â”‚     â””â”€ è®°å½•æ—¥å¿—å¹¶è¿”å›
â”‚
â””â”€ è®¾ç½® has_internal_error = true
   å†…å®¹: error_message
```

---

## ğŸ’¾ å·¥å…·è°ƒç”¨è¿½è¸ªç¤ºä¾‹

```
æ‰§è¡Œæµç¨‹:
1. find_data (call_001)
   â”œâ”€ input: {table_name: "order"}
   â””â”€ output: {columns: [...]}

2. generate_sql (call_002)
   â”œâ”€ input: {table_info: call_001.output}
   â””â”€ output: {sql: "SELECT..."}

3. execute_sql (call_003)
   â”œâ”€ input: {sql: call_002.output}
   â””â”€ output: {result: [...]}

çŠ¶æ€è®°å½•:
session_tool_call_info {
    tool_call_name_mapping: {
        "call_001": "find_data",
        "call_002": "generate_sql",
        "call_003": "execute_sql_and_analyze_result"
    },
    tool_call_input_mapping: {
        "call_001": {table_name: "order"},
        "call_002": {table_info: {...}},
        "call_003": {sql: "SELECT..."}
    },
    tool_call_output_mapping: {
        "call_001": {columns: [...]},
        "call_002": {sql: "SELECT..."},
        "call_003": {result: [...]}
    }
}
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æ¶æ„

### ç¼“å­˜å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æœ¬åœ°ç¼“å­˜ (LocalMemory)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€ è¡¨ç»“æ„ç¼“å­˜                   â”‚
â”‚ â”œâ”€ SQLæ¨¡æ¿ç¼“å­˜                  â”‚
â”‚ â”œâ”€ ç”¨æˆ·åå¥½ç¼“å­˜                 â”‚
â”‚ â””â”€ å·¥å…·å“åº”ç¼“å­˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åˆ†å¸ƒå¼ç¼“å­˜ (Redis/Memcached) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€ è·¨ä¼šè¯ç¼“å­˜                   â”‚
â”‚ â”œâ”€ é›†ç¾¤çº§ç¼“å­˜                   â”‚
â”‚ â””â”€ çƒ­ç‚¹æ•°æ®ç¼“å­˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åç«¯æœåŠ¡æ•°æ®åº“             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€ Hive (æ•°æ®ä»“åº“)              â”‚
â”‚ â”œâ”€ Milvus (å‘é‡æœç´¢)            â”‚
â”‚ â””â”€ Elasticsearch (æœç´¢å¼•æ“)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— é›†æˆç‚¹

```
Common Agent
    â”‚
    â”œâ”€â†’ get_auth_user_info()
    â”‚   â””â”€ è·å–ç”¨æˆ·èƒŒæ™¯ä¿¡æ¯
    â”‚
    â”œâ”€â†’ LLM (GPT-4)
    â”‚   â””â”€ å·¥å…·é€‰æ‹©å’Œæ¨ç†
    â”‚
    â”œâ”€â†’ Sub-Agents
    â”‚   â”œâ”€ Data Discovery Agent
    â”‚   â”œâ”€ Text2SQL Agent
    â”‚   â”œâ”€ Fix SQL Agent
    â”‚   â”œâ”€ Chat BI Agent
    â”‚   â”œâ”€ Explain SQL Agent
    â”‚   â””â”€ Logify Agent
    â”‚
    â””â”€â†’ åç«¯æœåŠ¡
        â”œâ”€ Hive/Presto
        â”œâ”€ Milvus
        â”œâ”€ Elasticsearch
        â””â”€ MySQL (çŸ¥è¯†åº“)
```

---

**æ¶æ„å›¾æœ€åæ›´æ–°**: 2024å¹´10æœˆ27æ—¥
