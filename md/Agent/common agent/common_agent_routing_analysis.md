# Common Agent è·¯ç”±ç³»ç»Ÿè¯¦ç»†åˆ†æ

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [æ¶ˆæ¯è·¯ç”±æµç¨‹](#æ¶ˆæ¯è·¯ç”±æµç¨‹)
4. [Agent æ˜ å°„å…³ç³»](#agent-æ˜ å°„å…³ç³»)
5. [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
6. [å·¥å…·è°ƒç”¨é“¾](#å·¥å…·è°ƒç”¨é“¾)
7. [è·¯ç”±å†³ç­–æœºåˆ¶](#è·¯ç”±å†³ç­–æœºåˆ¶)
8. [å®é™…æ¡ˆä¾‹æµç¨‹](#å®é™…æ¡ˆä¾‹æµç¨‹)

---

## ç³»ç»Ÿæ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½

Common Agent æ˜¯ DI Brain çš„**æ¶ˆæ¯è·¯ç”±ä¸­æ¢**ï¼Œè´Ÿè´£ï¼š

1. **æ¶ˆæ¯æ¥æ”¶ä¸è§£æ** - æ¥æ”¶ç”¨æˆ·é—®é¢˜å¹¶è¿›è¡Œåˆæ­¥åˆ†æ
2. **Agent è¯†åˆ«** - æ ¹æ®ç”¨æˆ·æ„å›¾è¯†åˆ«æ‰€éœ€çš„ Sub-Agent
3. **çŠ¶æ€ç»´æŠ¤** - è·Ÿè¸ªå’Œç®¡ç†æ•´ä¸ªå¯¹è¯è¿‡ç¨‹çš„çŠ¶æ€
4. **ç»“æœåˆæˆ** - ä»å„ä¸ª Sub-Agent æ”¶é›†ç»“æœå¹¶è¿”å›ç»™ç”¨æˆ·

### æ¶æ„å±‚çº§

```
ç”¨æˆ·æ¶ˆæ¯è¾“å…¥
    â†“
Common Agent (è·¯ç”±å†³ç­–å±‚)
  1. æ¶ˆæ¯é¢„å¤„ç†
  2. æ„å›¾è¯†åˆ«
  3. çŠ¶æ€åˆå§‹åŒ–
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sub-Agents       â”‚
â”œâ”€ Data Discovery  â”‚
â”œâ”€ Text2SQL        â”‚
â”œâ”€ Fix SQL         â”‚
â”œâ”€ Chat BI         â”‚
â”œâ”€ Explain SQL     â”‚
â””â”€ Logify          â”‚
    â†“
ç»“æœèšåˆä¸æ ¼å¼åŒ–
    â†“
è¿”å›æœ€ç»ˆç»“æœç»™ç”¨æˆ·
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. **common_agent_prompt.py** - Prompt æ¨¡æ¿

**æ–‡ä»¶è·¯å¾„**: `/Users/zhilong.zhang/PycharmProjects/di-brain/di_brain/router/common_agent_prompt.py`

**ä½œç”¨**: å®šä¹‰ Common Agent çš„è¡Œä¸ºå‡†åˆ™å’Œèƒ½åŠ›æè¿°

**æ ¸å¿ƒèƒ½åŠ›**:
- Analyze Data Domains (åˆ†ææ•°æ®åŸŸ)
- Find Tables & Columns (æŸ¥æ‰¾è¡¨å’Œåˆ—)
- Generate & Adjust Presto SQL (ç”Ÿæˆ/è°ƒæ•´SQL)
- Execute SQL & Analyze Results (æ‰§è¡ŒSQLå¹¶åˆ†æ)
- Fix SQL (ä¿®å¤SQL)
- Query Logs (æŸ¥è¯¢æ—¥å¿—)

**å·¥ä½œæµä¼˜å…ˆçº§**:
1. é—®é¢˜åˆ†æä¸æµç¨‹ç”Ÿæˆ
2. ç®€å•çŸ­è¯­é‡å†™
3. å¤„ç†æ¨¡ç³Šä¸ç¼ºå¤±ä¿¡æ¯
4. å·¥å…·ä¼˜å…ˆçº§æ’åº
5. è¡¨åé¢„åˆ¤
6. æ•°æ®åŸŸæ£€æµ‹

### 2. **common_agent_state.py** - çŠ¶æ€å®šä¹‰

**æ–‡ä»¶è·¯å¾„**: `/Users/zhilong.zhang/PycharmProjects/di-brain/di_brain/router/common_agent_state.py`

**ä½œç”¨**: å®šä¹‰æ•´ä¸ªå¯¹è¯è¿‡ç¨‹ä¸­ç»´æŠ¤çš„çŠ¶æ€ä¿¡æ¯

**æ ¸å¿ƒæ•°æ®ç»“æ„**:
- `question`: ç”¨æˆ·é—®é¢˜
- `selected_tables`: é€‰ä¸­çš„è¡¨åˆ—è¡¨
- `selected_assets`: é€‰ä¸­çš„èµ„æº
- `session_tool_call_info`: ä¼šè¯çº§å·¥å…·è°ƒç”¨ä¿¡æ¯
- `chat_tool_call_info`: èŠå¤©çº§å·¥å…·è°ƒç”¨ä¿¡æ¯
- `ask_human`: å‘ç”¨æˆ·è¯¢é—®çš„é—®é¢˜
- `chat_dataset_sample_data_mapping`: æ•°æ®é›†æ ·æœ¬æ•°æ®æ˜ å°„

### 3. **common_agent_tools.py** - å·¥å…·ç®¡ç†

**æ–‡ä»¶è·¯å¾„**: `/Users/zhilong.zhang/PycharmProjects/di-brain/di_brain/router/common_agent_tools.py`

**ä¸»è¦åŠŸèƒ½**:

1. **å·¥å…·æŸ¥è¯¢æ–¹æ³•**:
   - `find_latest_find_data_tool_message()` - æŸ¥æ‰¾æœ€æ–°çš„æ•°æ®æŸ¥è¯¢å·¥å…·æ¶ˆæ¯
   - `get_find_data_tool_io_by_tool_call_id()` - é€šè¿‡IDè·å–å·¥å…·æ•°æ®

2. **Agent-Tool æ˜ å°„**:
   - ask_human â†’ Common Agent
   - find_data â†’ Data Discovery
   - generate_sql â†’ Text2SQL Agent
   - fix_sql â†’ Fix SQL Agent
   - execute_sql_and_analyze_result â†’ Chat BI Agent
   - explain_sql â†’ Explain SQL Agent
   - search_log â†’ Logify Agent
   - detect_data_domain â†’ Data Scope Clarification Agent

3. **LLM å‡†å¤‡**:
   - `prepare_llm_with_tools()` - å°†å·¥å…·ç»‘å®šåˆ°LLM
   - `prepare_tool_node()` - åˆ›å»ºå·¥å…·æ‰§è¡ŒèŠ‚ç‚¹

### 4. **tool_router.py** - è·¯ç”±æ ¸å¿ƒ

**æ–‡ä»¶è·¯å¾„**: `/Users/zhilong.zhang/PycharmProjects/di-brain/di_brain/router/tool_router.py`

**ä¸»è¦èŒè´£**:
- æ¶ˆæ¯è·¯ç”±å†³ç­–
- çŠ¶æ€åˆå§‹åŒ–å’Œç®¡ç†
- Sub-Agent è°ƒç”¨
- ç»“æœèšåˆå’Œå¤„ç†

---

## æ¶ˆæ¯è·¯ç”±æµç¨‹

### è¯¦ç»†æµç¨‹æ­¥éª¤

**æ­¥éª¤1: æ¶ˆæ¯æ¥æ”¶ä¸åˆå§‹åŒ–**
```python
Input:
- question: ç”¨æˆ·é—®é¢˜
- chat_history: èŠå¤©å†å²
- chat_context: èŠå¤©ä¸Šä¸‹æ–‡ (ç”¨æˆ·ä¿¡æ¯ã€éƒ¨é—¨ç­‰)
- selected_assets: ç”¨æˆ·é€‰ä¸­çš„èµ„æº
```

**æ­¥éª¤2: åˆ›å»ºå’Œåˆå§‹åŒ– CommonAgentState**
- åˆå§‹åŒ– `session_tool_call_info` å’Œ `chat_tool_call_info`
- è·å–ç”¨æˆ·èƒŒæ™¯ä¿¡æ¯ (éƒ¨é—¨ã€åœ°åŒºã€é»˜è®¤é¡¹ç›®)
- æ³¨å…¥ç”¨æˆ·èƒŒæ™¯åˆ° System Prompt

**æ­¥éª¤3: èŠå¤©å†å²è½¬æ¢**
- SystemMessage: Prompt with User Context
- HumanMessage: å†å²ç”¨æˆ·é—®é¢˜
- AIMessage: å†å²AIå“åº”
- ToolMessage: å†å²å·¥å…·è°ƒç”¨ç»“æœ

**æ­¥éª¤4: LLM æ¨ç†å’Œå†³ç­–**
- å°†æ¶ˆæ¯å’Œå·¥å…·å‘é€ç»™LLM
- LLM åˆ†æç”¨æˆ·æ„å›¾
- LLM å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·

**æ­¥éª¤5: å·¥å…·è·¯ç”±å’Œæ‰§è¡Œ**
- æ ¹æ®LLMå†³ç­–è·¯ç”±åˆ°å¯¹åº”å·¥å…·
- æ‰§è¡Œå¯¹åº”çš„Sub-Agent

**æ­¥éª¤6: ç»“æœæ”¶é›†å’ŒçŠ¶æ€æ›´æ–°**
- ä¿å­˜å·¥å…·è°ƒç”¨IDã€è¾“å…¥ã€è¾“å‡º
- æ›´æ–°çŠ¶æ€ä¿¡æ¯

**æ­¥éª¤7: å¾ªç¯åˆ¤æ–­**
- å¦‚æœéœ€è¦ç»§ç»­æ‰§è¡Œ â†’ å›åˆ°æ­¥éª¤4
- å¦åˆ™ â†’ è¿›å…¥æ­¥éª¤8

**æ­¥éª¤8: è¿”å›æœ€ç»ˆå“åº”**
- è¿”å› CommonAgentResponse å¯¹è±¡
- åŒ…å«æœ€ç»ˆç»“æœå’Œå®Œæ•´çŠ¶æ€ä¿¡æ¯

---

## Agent æ˜ å°„å…³ç³»

### Tool â†’ Agent æ˜ å°„è¡¨

| å·¥å…·åç§° | Sub-Agent åç§° | åŠŸèƒ½æè¿° | ä¼˜å…ˆçº§ |
|---------|----------------|---------|--------|
| ask_human | Common Agent | å‘ç”¨æˆ·è¯·æ±‚ä¿¡æ¯ | ğŸ”´ æœ€é«˜ |
| detect_data_domain | Data Scope Clarification Agent | æ£€æµ‹æ•°æ®åŸŸèŒƒå›´ | ğŸŸ  é«˜ |
| find_data | Data Discovery | æŸ¥æ‰¾ç›¸å…³çš„Hiveè¡¨ | ğŸŸ  é«˜ |
| generate_sql | Text2SQL Agent | æ ¹æ®é—®é¢˜ç”ŸæˆSQL | ğŸŸ¡ ä¸­ |
| execute_sql_and_analyze_result | Chat BI Agent | æ‰§è¡ŒSQLå¹¶åˆ†æ | ğŸŸ¡ ä¸­ |
| fix_sql | Fix SQL Agent | ä¿®å¤æœ‰é”™è¯¯çš„SQL | ğŸŸ¡ ä¸­ |
| explain_sql | Explain SQL Agent | è§£é‡ŠSQLè¯­å¥ | ğŸŸ¢ ä½ |
| search_log | Logify Agent | åœ¨Logifyä¸­æŸ¥è¯¢æ—¥å¿— | ğŸŸ¢ ä½ |

---

## çŠ¶æ€ç®¡ç†

### å·¥å…·è°ƒç”¨ä¿¡æ¯è¿½è¸ª

```python
class ToolCallInfo(TypedDict):
    tool_call_id: str                    # å·¥å…·è°ƒç”¨çš„å”¯ä¸€ID
    tool_call_name: str                  # å·¥å…·åç§°
    tool_call_input: Dict[str, Any]      # å·¥å…·è¾“å…¥å‚æ•°
    tool_call_output: Dict[str, Any]     # å·¥å…·è¾“å‡ºç»“æœ
    tool_call_error: Optional[str]       # å·¥å…·æ‰§è¡Œé”™è¯¯
```

### å¤šçº§çŠ¶æ€ä¿å­˜

```
CommonAgentState
â”œâ”€ session_tool_call_info (ä¼šè¯çº§)
â”‚  â”œâ”€ tool_call_id_mapping
â”‚  â”œâ”€ tool_call_name_mapping
â”‚  â”œâ”€ tool_call_input_mapping
â”‚  â””â”€ tool_call_output_mapping
â”œâ”€ chat_tool_call_info (èŠå¤©çº§)
â”‚  â”œâ”€ tool_call_id_mapping
â”‚  â”œâ”€ tool_call_name_mapping
â”‚  â”œâ”€ tool_call_input_mapping
â”‚  â””â”€ tool_call_output_mapping
â”œâ”€ messages (æ¶ˆæ¯å†å²)
â”‚  â”œâ”€ SystemMessage
â”‚  â”œâ”€ HumanMessage
â”‚  â”œâ”€ AIMessage
â”‚  â””â”€ ToolMessage
â””â”€ chat_dataset_sample_data_mapping
```

---

## å®é™…æ¡ˆä¾‹æµç¨‹

### æ¡ˆä¾‹1: æ•°æ®åˆ†ææŸ¥è¯¢

**ç”¨æˆ·é—®é¢˜**: "åˆ†æè¿‡å»7å¤©çš„è®¢å•æ•°æ®"

**æ‰§è¡Œæµç¨‹**:
1. Common Agent æ¥æ”¶é—®é¢˜
2. åˆ†ææ„å›¾ â†’ éœ€è¦æŸ¥è¯¢æ•°æ®å’Œåˆ†æ
3. è·¯ç”±åˆ° Data Discovery â†’ æŸ¥æ‰¾è®¢å•è¡¨
4. è·¯ç”±åˆ° Text2SQL Agent â†’ ç”ŸæˆæŸ¥è¯¢SQL
5. è·¯ç”±åˆ° Chat BI Agent â†’ æ‰§è¡Œå¹¶åˆ†æ
6. è¿”å›åˆ†æç»“æœ

### æ¡ˆä¾‹2: SQLä¿®å¤

**ç”¨æˆ·é—®é¢˜**: "è¿™ä¸ªSQLæœ‰é—®é¢˜: SELECT * FROM table WHERE date = 2024-01-01"

**æ‰§è¡Œæµç¨‹**:
1. Common Agent æ¥æ”¶é—®é¢˜å’ŒSQL
2. åˆ†ææ„å›¾ â†’ SQLä¿®å¤
3. è·¯ç”±åˆ° Fix SQL Agent â†’ ä¿®å¤SQL
4. (å¯é€‰) è·¯ç”±åˆ° Chat BI Agent â†’ æ‰§è¡Œä¿®å¤åçš„SQL
5. è¿”å›ä¿®å¤ç»“æœ

---

## å…³é”®è®¾è®¡ç‰¹ç‚¹

### 1. çŠ¶æ€çš„å¤šå±‚æ¬¡ç®¡ç†
- Sessionçº§: è·¨è¶Šæ•´ä¸ªä¼šè¯ä¿æŒçŠ¶æ€
- Chatçº§: åœ¨å•ä¸ªèŠå¤©æ¶ˆæ¯ä¸­ä¿æŒçŠ¶æ€
- å®Œæ•´çš„å·¥å…·è°ƒç”¨å†å²è¿½è¸ª

### 2. çµæ´»çš„å·¥å…·ç»„åˆ
- ä¸åˆ†è£‚é—®é¢˜: å•æ¬¡è¯·æ±‚å¤„ç†å®Œæ•´é—®é¢˜
- å·¥å…·é“¾å¼è°ƒç”¨: å‰ä¸€ä¸ªå·¥å…·çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªçš„è¾“å…¥
- è‡ªé€‚åº”è·¯ç”±: æ ¹æ®æ‰§è¡Œç»“æœåŠ¨æ€è°ƒæ•´è·¯ç”±

### 3. ç”¨æˆ·èƒŒæ™¯é›†æˆ
- è‡ªåŠ¨è·å–ç”¨æˆ·éƒ¨é—¨ã€åœ°åŒºã€é»˜è®¤é¡¹ç›®
- å°†ç”¨æˆ·èƒŒæ™¯æ³¨å…¥åˆ°ç³»ç»Ÿæç¤º
- æé«˜æ¨èå’Œåˆ†æçš„å‡†ç¡®æ€§

### 4. é”™è¯¯å¤„ç†ä¸æ¢å¤
- æ¯ä¸ªå·¥å…·è°ƒç”¨éƒ½æœ‰é”™è¯¯æ•è·
- æ”¯æŒå·¥å…·é”™è¯¯åçš„é‡è¯•
- å®Œæ•´çš„é”™è¯¯æ—¥å¿—è®°å½•

### 5. ä¼šè¯è¿ç»­æ€§
- å®Œæ•´çš„èŠå¤©å†å²å›æ”¾
- å·¥å…·è°ƒç”¨çŠ¶æ€çš„ä¿å­˜ä¸æ¢å¤
- æ”¯æŒå¤šè½®å¯¹è¯çš„å®Œæ•´ä¸Šä¸‹æ–‡

---

## æ€»ç»“

Common Agent é€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°é«˜æ•ˆçš„æ¶ˆæ¯è·¯ç”±ï¼š

1. **æ™ºèƒ½å†³ç­–** - åŸºäºç”¨æˆ·æ„å›¾æ™ºèƒ½è·¯ç”±
2. **çŠ¶æ€è¿½è¸ª** - å®Œæ•´è®°å½•æ¯ä¸ªå·¥å…·è°ƒç”¨
3. **é“¾å¼è°ƒç”¨** - æ”¯æŒå¤šä¸ªå·¥å…·çš„é¡ºåºæ‰§è¡Œ
4. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥** - èå…¥ç”¨æˆ·èƒŒæ™¯ä¿¡æ¯
5. **é”™è¯¯æ¢å¤** - å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

è¿™æ ·çš„è®¾è®¡ä½¿å¾—DI Brainèƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›ç»Ÿä¸€çš„æ¥å£ï¼ŒåŒæ—¶åœ¨åç«¯çµæ´»åœ°è°ƒåº¦å„ä¸ªä¸“ä¸šçš„Sub-Agentå®Œæˆå¤æ‚çš„æ•°æ®åˆ†æä»»åŠ¡ã€‚
